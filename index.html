<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Station Master: Chennai Central (MAS)</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --panel-bg: rgba(30, 30, 30, 0.95);
            --panel-border: rgba(255, 255, 255, 0.15);
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --accent-blue: #0a84ff;
            --accent-green: #30d158;
            --accent-red: #ff453a;
            --accent-yellow: #ffd60a;
            --accent-purple: #bf5af2;
            --accent-orange: #ff9f0a;
            --track-vacant: #3a3a3c;
            --track-occupied: #ff453a;
            --track-route: #ffd60a;
            --track-maint: #ff9f0a;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        html, body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-primary);
            font-family: var(--font-stack); overflow: hidden; height: 100dvh; width: 100vw;
            position: fixed; display: flex; flex-direction: column; touch-action: none; 
        }

        /* --- Day/Night & Weather FX --- */
        #sky-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 1;
            background: rgba(0,0,0,0); transition: background 2s ease;
        }
        .night-mode #sky-overlay { background: rgba(0, 5, 20, 0.6); } 
        
        #weather-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 5; opacity: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.1)); transition: opacity 1s;
        }
        .rain {
            position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; pointer-events: none; z-index: 6;
            background-image: repeating-linear-gradient(170deg, transparent, transparent 40px, rgba(255,255,255,0.1) 40px, rgba(255,255,255,0.1) 42px);
            background-size: 1000% 1000%; animation: rain 1s linear infinite;
        }
        @keyframes rain { from { background-position: 0% 0%; } to { background-position: 10% 100%; } }
        .lightning {
            position: absolute; top:0; left:0; width:100%; height:100%; background: white; opacity: 0; pointer-events: none; z-index: 7;
        }

        /* --- Header --- */
        header {
            height: 50px; flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; background: rgba(20, 20, 20, 0.95); border-bottom: 1px solid var(--panel-border); z-index: 20;
        }
        .station-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .station-code { background: var(--text-secondary); color: black; font-size: 11px; padding: 2px 5px; border-radius: 4px; font-weight: 700; }
        .status-indicators { display: flex; gap: 8px; }
        .status-badge {
            display: flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 600;
            padding: 3px 8px; border-radius: 12px; border: 1px solid; white-space: nowrap;
        }
        .status-kavach { color: var(--accent-orange); background: rgba(255, 159, 10, 0.1); border-color: var(--accent-orange); }
        .status-time { color: #fff; border-color: #555; width: 80px; justify-content: center;}
        
        .stats-bar { display: flex; gap: 15px; font-variant-numeric: tabular-nums; }
        .stat-item { display: flex; flex-direction: column; align-items: flex-end; }
        .stat-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; }
        .stat-value { font-size: 14px; font-weight: 500; }

        /* --- Layout --- */
        .game-container { display: flex; flex: 1; position: relative; height: calc(100dvh - 50px); }
        .sidebar {
            width: 260px; background: var(--panel-bg); border-right: 1px solid var(--panel-border);
            padding: 12px; display: flex; flex-direction: column; gap: 10px; z-index: 10; overflow-y: auto; flex-shrink: 0;
        }
        h2 { font-size: 11px; color: var(--text-secondary); margin: 0 0 4px 0; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        button {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary);
            padding: 8px; border-radius: 6px; font-family: var(--font-stack); font-size: 12px; font-weight: 500;
            cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center;
        }
        button:active { background: rgba(255,255,255,0.2); }
        button:disabled { opacity: 0.5; }
        .btn-spawn-local { border-left: 3px solid var(--accent-yellow); }
        .btn-spawn-express { border-left: 3px solid var(--accent-blue); }
        .btn-emergency { background: rgba(255, 69, 58, 0.2); border-color: var(--accent-red); color: var(--accent-red); }
        .btn-ai { background: rgba(191, 90, 242, 0.15); border-color: var(--accent-purple); color: #e0c0ff; }
        .btn-toggle.active { background: var(--accent-orange); color: black; border-color: var(--accent-orange); }

        .live-status {
            background: rgba(0,0,0,0.4); border-radius: 6px; padding: 6px; font-size: 10px;
            max-height: 80px; overflow-y: auto; border: 1px solid var(--panel-border);
        }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .status-delayed { color: var(--accent-red); animation: blink 2s infinite; }
        .status-ontime { color: var(--accent-green); }
        .status-acp { color: var(--accent-red); font-weight: bold; animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .log-panel {
            flex: 1; background: rgba(0,0,0,0.4); border-radius: 6px; padding: 6px; overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', monospace; font-size: 10px; color: #aaa;
            display: flex; flex-direction: column-reverse; border: 1px solid var(--panel-border);
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-err { color: var(--accent-red); }
        .log-success { color: var(--accent-green); }
        .log-warn { color: var(--accent-orange); }
        .log-ai { color: var(--accent-purple); font-style: italic; }

        /* --- Canvas --- */
        .canvas-area {
            flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        svg { width: 100%; height: 100%; display: block; }
        .hit-area { fill: transparent; cursor: pointer; }
        
        .track-line { fill: none; stroke: var(--track-vacant); stroke-width: 5; stroke-linecap: round; transition: stroke 0.2s; }
        .track-line.occupied { stroke: var(--track-occupied); }
        .track-line.route-locked { stroke: var(--track-route); }
        .track-line.maintenance { stroke: var(--track-maint); stroke-dasharray: 10, 5; }
        /* Night Mode Glows */
        .night-mode .track-line.route-locked { filter: drop-shadow(0 0 5px var(--accent-yellow)); }
        .night-mode .track-line.occupied { filter: drop-shadow(0 0 5px var(--accent-red)); }

        /* NEW: Improved Point & Track Interactions */
        .point-group { cursor: pointer; }
        .point-group:hover .point-circle { 
            stroke: #fff; stroke-width: 3px; 
            fill: #444; transform: scale(1.3); 
            filter: drop-shadow(0 0 5px var(--accent-yellow));
        }
        .point-group:hover .point-indicator { transform: scale(1.5); fill: #fff; }
        
        /* Make tracks glow when hovering their hit area for routing */
        .track-group:hover .track-line { stroke: #666; filter: drop-shadow(0 0 3px #fff); }
        .track-group:hover .track-line.route-locked { stroke: #ffe066; }

        .platform-rect { fill: rgba(255,255,255,0.1); }
        .platform-text { fill: rgba(255,255,255,0.4); font-size: 12px; font-weight: 700; }
        .label-text { font-size: 10px; fill: #666; font-weight: bold; pointer-events: none; }

        .point-circle { fill: #222; stroke: #888; stroke-width: 2; transition: all 0.2s; pointer-events: none; }
        .point-indicator { fill: var(--accent-yellow); opacity: 0; pointer-events: none; transition: all 0.2s; }
        .point-arrow { fill: none; stroke: var(--accent-yellow); stroke-width: 2; opacity: 0.5; pointer-events: none; }
        
        .signal-light { stroke: #111; stroke-width: 1; transition: filter 0.2s; pointer-events: none; }
        .signal-active-red { fill: #ff3b30; box-shadow: 0 0 8px #ff3b30; }
        .signal-active-yellow { fill: #ffd60a; box-shadow: 0 0 8px #ffd60a; }
        .signal-active-double-yellow { fill: #ffd60a; box-shadow: 0 0 12px #ffd60a; stroke: #fff; stroke-width: 2px; }
        .signal-active-green { fill: #30d158; box-shadow: 0 0 8px #30d158; }
        
        .night-mode .signal-active-red { box-shadow: 0 0 15px #ff3b30; }
        .night-mode .signal-active-green { box-shadow: 0 0 15px #30d158; }

        .train-group { transition: transform 0.1s linear; pointer-events: none; cursor: pointer; }
        .train-body { stroke: none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transition: fill 0.3s; }
        .train-acp .train-body { fill: #ff453a !important; animation: blink 0.3s infinite; }
        .train-local { fill: var(--accent-yellow); }
        .train-express { fill: var(--accent-blue); }
        .train-label { font-size: 9px; fill: white; font-weight: bold; text-anchor: middle; text-shadow: 0 1px 2px black; }
        .train-group.train-acp { pointer-events: all; }

        .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.active { opacity: 1; pointer-events: all; }
        .modal {
            background: #1c1c1e; border: 1px solid #333; padding: 30px; border-radius: 16px;
            text-align: center; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .btn-primary { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; font-size: 14px; width: 100%; justify-content: center; }
        .ai-report-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 15px 0; font-family: monospace; text-align: left; font-size: 10px; max-height: 150px; overflow-y: auto; display: none; }
        .spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s infinite linear; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .game-container { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 200px; border-right: none; border-top: 1px solid var(--panel-border); }
        }
    </style>
</head>
<body class="day-mode"> <!-- Default -->

    <header>
        <div class="station-title"><span>Chennai Central</span><span class="station-code">MAS</span></div>
        <div class="status-indicators">
            <div class="status-badge status-time" id="game-time">12:00</div>
            <div class="status-badge status-kavach" id="kavach-indicator">üõ°Ô∏è KAVACH</div>
        </div>
        <div class="stats-bar">
            <div class="stat-item"><span class="stat-label">Score</span><span class="stat-value" id="score">0</span></div>
            <div class="stat-item"><span class="stat-label">Trains</span><span class="stat-value" id="train-count">0</span></div>
        </div>
    </header>

    <div class="game-container">
        <div id="sky-overlay"></div>
        <div id="weather-overlay"></div><div id="rain-layer" class="rain"></div><div id="lightning-layer" class="lightning"></div>
        <aside class="sidebar">
            <div class="control-group">
                <h2>Traffic Control</h2>
                <div style="display:flex; gap:5px;">
                    <button class="btn-spawn-local" onclick="game.spawnTrain('local')" style="flex:1"><span>Spawn EMU</span></button>
                    <button class="btn-spawn-express" onclick="game.spawnTrain('express')" style="flex:1"><span>Spawn Exp</span></button>
                </div>
            </div>
            <div class="control-group">
                <h2>Operations</h2>
                <button id="btn-maint" class="btn-toggle" onclick="game.toggleMaintenanceMode()"><span>üöß Maintenance Mode</span></button>
            </div>
            <div class="control-group">
                <h2>Live Status</h2>
                <div class="live-status" id="live-status-board"><div style="text-align:center; color:#666;">No Active Trains</div></div>
            </div>
            <div class="control-group">
                <h2>AI Assistance</h2>
                <div style="display:flex; gap:5px;">
                    <button class="btn-ai" id="btn-announce" onclick="game.triggerAnnouncement()" style="flex:1"><span>Announce</span></button>
                    <button class="btn-ai" id="btn-consult" onclick="game.consultControl()" style="flex:1"><span>Consult</span></button>
                </div>
            </div>
            <div class="control-group">
                <h2>Safety</h2>
                <button class="btn-emergency" onclick="game.emergencyStop()">üö® EMERGENCY STOP</button>
                <button class="btn-reset" onclick="game.resetBoard()">Reset Panel</button>
            </div>
            <div class="log-panel" id="log"><div class="log-entry">System Initialized.</div></div>
        </aside>
        <main class="canvas-area">
            <svg id="rri-panel" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet"></svg>
        </main>
    </div>

    <div id="start-overlay" class="overlay active">
        <div class="modal">
            <h1>Station Master</h1>
            <p style="color:#888; font-size: 13px;">Chennai Central (MAS)</p>
            <p style="font-size: 12px; color: #aaa; text-align: left; line-height: 1.6;">
                üëÜ <b>Easier Controls:</b> Points now glow! Click big circles or track lines to switch.<br>
                üåû <b>Day/Night:</b> Dynamic environment.<br>
                üö¶ <b>4-Aspect Signals:</b> Red, Yellow, Double Yellow, Green.<br>
                üö® <b>Chain Pulling:</b> Tap train to reset if halted.
            </p>
            <button class="btn-primary" onclick="game.start()">Start Shift</button>
        </div>
    </div>

    <div id="game-over-overlay" class="overlay">
        <div class="modal">
            <h1 style="color: var(--accent-red)">CRITICAL FAILURE</h1>
            <p id="fail-reason">Collision Detected.</p>
            <div class="stat-value" id="final-score">Score: 0</div>
            <div id="ai-report-container" class="ai-report-box"></div>
            <button class="btn-ai" id="btn-report" onclick="game.generateAccidentReport()" style="margin-top: 10px; width: 100%; justify-content: center;">‚ú® Generate Inquiry Report</button>
            <button class="btn-primary" onclick="location.reload()" style="margin-top: 10px;">Return to Duty</button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        async function callGemini(p) {
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:p}]}]})});
                if(!r.ok) throw new Error('API'); const d=await r.json(); return d.candidates[0].content.parts[0].text;
            } catch(e) { return "AI Offline."; }
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if(type==='click'){o.type='sine';o.frequency.setValueAtTime(800,now);o.frequency.exponentialRampToValueAtTime(300,now+0.1);g.gain.setValueAtTime(0.1,now);g.gain.linearRampToValueAtTime(0,now+0.1);o.start(now);o.stop(now+0.1);}
            if(type==='error'){o.type='sawtooth';o.frequency.setValueAtTime(150,now);g.gain.setValueAtTime(0.2,now);g.gain.linearRampToValueAtTime(0,now+0.4);o.start(now);o.stop(now+0.4);}
            if(type==='acp'){o.type='square';o.frequency.setValueAtTime(600,now);o.frequency.linearRampToValueAtTime(400,now+0.5);g.gain.setValueAtTime(0.2,now);g.gain.linearRampToValueAtTime(0,now+0.5);o.start(now);o.stop(now+0.5);}
            if(type==='success'){o.type='triangle';o.frequency.setValueAtTime(400,now);g.gain.setValueAtTime(0.1,now);g.gain.linearRampToValueAtTime(0,now+0.3);o.start(now);o.stop(now+0.3);}
        }

        const NODES = {
            'up_entry': {x: 50, y: 250},
            'sw_up_entry': {x: 150, y: 250}, 
            'sw_up_xover': {x: 300, y: 250}, 
            'down_exit': {x: 50, y: 450},
            'sw_down_exit': {x: 150, y: 450},
            'sw_down_xover': {x: 300, y: 450},
            'sw_pf_top': {x: 500, y: 200}, 
            'sw_pf_mid': {x: 500, y: 350},
            'sw_pf_bot': {x: 500, y: 500},
            // Platforms
            'pf1_s': {x: 700, y: 100}, 'pf1_e': {x: 950, y: 100},
            'pf2_s': {x: 700, y: 200}, 'pf2_e': {x: 950, y: 200},
            'pf3_s': {x: 700, y: 300}, 'pf3_e': {x: 950, y: 300},
            'pf4_s': {x: 700, y: 400}, 'pf4_e': {x: 950, y: 400},
            'pf5_s': {x: 700, y: 500}, 'pf5_e': {x: 950, y: 500},
            'pf6_s': {x: 700, y: 600}, 'pf6_e': {x: 950, y: 600},
        };

        const TRACKS = [
            {id: 't_up_1', u: 'up_entry', v: 'sw_up_entry', limit: 1.0},
            {id: 't_up_2', u: 'sw_up_entry', v: 'sw_up_xover', limit: 1.0},
            {id: 't_down_1', u: 'sw_down_exit', v: 'down_exit', limit: 1.0},
            {id: 't_down_2', u: 'sw_down_xover', v: 'sw_down_exit', limit: 1.0},
            {id: 't_link_up_top', u: 'sw_up_xover', v: 'sw_pf_top', limit: 0.5}, 
            {id: 't_link_up_mid', u: 'sw_up_xover', v: 'sw_pf_mid', limit: 0.5},
            {id: 't_link_bot_down', u: 'sw_pf_bot', v: 'sw_down_xover', limit: 0.5},
            {id: 't_link_mid_down', u: 'sw_pf_mid', v: 'sw_down_xover', limit: 0.5},
            {id: 't_pf1_link', u: 'sw_pf_top', v: 'pf1_s', limit: 0.3},
            {id: 't_pf2_link', u: 'sw_pf_top', v: 'pf2_s', limit: 0.3},
            {id: 't_pf3_link', u: 'sw_pf_mid', v: 'pf3_s', limit: 0.3},
            {id: 't_pf4_link', u: 'sw_pf_mid', v: 'pf4_s', limit: 0.3},
            {id: 't_pf5_link', u: 'sw_pf_bot', v: 'pf5_s', limit: 0.3},
            {id: 't_pf6_link', u: 'sw_pf_bot', v: 'pf6_s', limit: 0.3},
            // Platforms (SHORT vs LONG)
            {id: 't_pf1', u: 'pf1_s', v: 'pf1_e', isPlatform: true, name: 'PF 1 (Short)', limit: 0.2, short: true},
            {id: 't_pf2', u: 'pf2_s', v: 'pf2_e', isPlatform: true, name: 'PF 2 (Short)', limit: 0.2, short: true},
            {id: 't_pf3', u: 'pf3_s', v: 'pf3_e', isPlatform: true, name: 'PF 3', limit: 0.2},
            {id: 't_pf4', u: 'pf4_s', v: 'pf4_e', isPlatform: true, name: 'PF 4', limit: 0.2},
            {id: 't_pf5', u: 'pf5_s', v: 'pf5_e', isPlatform: true, name: 'PF 5', limit: 0.2},
            {id: 't_pf6', u: 'pf6_s', v: 'pf6_e', isPlatform: true, name: 'PF 6', limit: 0.2},
        ];

        const POINTS = [
            {id: 'p_up', node: 'sw_up_xover', normal: 't_link_up_mid', reverse: 't_link_up_top', state: 'normal'},
            {id: 'p_down', node: 'sw_down_xover', normal: 't_link_mid_down', reverse: 't_link_bot_down', state: 'normal'},
            {id: 'p_top', node: 'sw_pf_top', normal: 't_pf2_link', reverse: 't_pf1_link', state: 'normal'},
            {id: 'p_mid', node: 'sw_pf_mid', normal: 't_pf4_link', reverse: 't_pf3_link', state: 'normal'},
            {id: 'p_bot', node: 'sw_pf_bot', normal: 't_pf5_link', reverse: 't_pf6_link', state: 'normal'},
        ];

        const SIGNALS = [
            {id: 's_home', node: 'up_entry', direction: 'up', state: 'red'}, 
            {id: 's_route_up', node: 'sw_up_xover', direction: 'up', state: 'red'}, 
            {id: 's_inner_top', node: 'sw_pf_top', direction: 'up', state: 'red'},
            {id: 's_inner_mid', node: 'sw_pf_mid', direction: 'up', state: 'red'},
            {id: 's_inner_bot', node: 'sw_pf_bot', direction: 'up', state: 'red'},
            {id: 's_st_1', node: 'pf1_s', direction: 'down', state: 'red'},
            {id: 's_st_2', node: 'pf2_s', direction: 'down', state: 'red'},
            {id: 's_st_3', node: 'pf3_s', direction: 'down', state: 'red'},
            {id: 's_st_4', node: 'pf4_s', direction: 'down', state: 'red'},
            {id: 's_st_5', node: 'pf5_s', direction: 'down', state: 'red'},
            {id: 's_st_6', node: 'pf6_s', direction: 'down', state: 'red'},
            {id: 's_adv_down', node: 'sw_down_xover', direction: 'down', state: 'red'},
        ];

        const LOCAL_NAMES = ['Arakkonam','Tiruvallur','Avadi','Pattabiram','Gummidipundi','Sullurpeta','Ennore','Villivakkam','Ambattur','Tiruttani'];
        const EXPRESS_NAMES = ['Shatabdi','Grand Trunk','Pinakini','Brindavan','Lalbagh','Kovai','Pallavan','Vaigai','Charminar','Vande Bharat'];

        class Train {
            constructor(id, type, name) {
                this.id = id; this.type = type; this.name = name;
                this.speed = 0; this.maxSpeed = type==='local'?0.7:1.1;
                this.currentTrackId = 't_up_1';
                this.progress = 0; this.direction = 1; this.state = 'running'; // running, waiting, departing, acp
                this.waitTime = 0; this.delayed = Math.random()>0.7;
                this.statusText = this.delayed?"Delayed":"On Time";
                this.kavachActive = false;
                // ACP specific
                this.acpActive = false;
            }
        }

        class Game {
            constructor() {
                this.svg = document.getElementById('rri-panel');
                this.trains = []; this.score = 0; this.lastFrame = 0; this.isRunning = false;
                this.trainIdCounter = 12601; this.maintenanceMode = false; this.maintenanceTracks = new Set();
                this.gameTime = 12 * 60; // Minutes from midnight
                this.timeRate = 20; // x Speed
            }
            init() { this.drawBoard(); this.updateScore(); }
            
            start() {
                document.getElementById('start-overlay').classList.remove('active');
                this.isRunning = true; this.lastFrame = performance.now();
                this.log("Shift Started.");
                document.getElementById('kavach-indicator').style.opacity = '1';
                document.getElementById('kavach-indicator').style.filter = 'none';
                requestAnimationFrame(t=>this.loop(t));
            }

            drawBoard() {
                this.svg.innerHTML = '';
                const lbl1 = document.createElementNS('http://www.w3.org/2000/svg','text');
                lbl1.setAttribute('x', 20); lbl1.setAttribute('y', 240); lbl1.textContent = "UP MAIN"; lbl1.classList.add('label-text');
                this.svg.appendChild(lbl1);
                const lbl2 = document.createElementNS('http://www.w3.org/2000/svg','text');
                lbl2.setAttribute('x', 20); lbl2.setAttribute('y', 440); lbl2.textContent = "DOWN MAIN"; lbl2.classList.add('label-text');
                this.svg.appendChild(lbl2);

                TRACKS.forEach(t => {
                    const u = NODES[t.u], v = NODES[t.v];
                    
                    const group = document.createElementNS('http://www.w3.org/2000/svg','g');
                    group.classList.add('track-group');
                    
                    if(t.isPlatform) {
                        const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
                        r.setAttribute('x', u.x); r.setAttribute('y', u.y-15); r.setAttribute('width', v.x-u.x); r.setAttribute('height',30);
                        r.classList.add('platform-rect'); this.svg.appendChild(r);
                        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
                        txt.setAttribute('x', u.x+10); txt.setAttribute('y', u.y+5); txt.classList.add('platform-text'); txt.textContent=t.name;
                        this.svg.appendChild(txt);
                    }
                    const p = document.createElementNS('http://www.w3.org/2000/svg','path');
                    p.setAttribute('d', `M${u.x},${u.y} L${v.x},${v.y}`); p.classList.add('track-line'); p.id=`visual_${t.id}`;
                    const hit = document.createElementNS('http://www.w3.org/2000/svg','path');
                    hit.setAttribute('d', `M${u.x},${u.y} L${v.x},${v.y}`); hit.setAttribute('stroke','transparent'); hit.setAttribute('stroke-width','35'); hit.classList.add('hit-area');
                    hit.onclick=()=>this.handleTrackClick(t.id);
                    
                    group.appendChild(p); group.appendChild(hit);
                    this.svg.appendChild(group);
                });

                POINTS.forEach(p => {
                    const n = NODES[p.node];
                    
                    const group = document.createElementNS('http://www.w3.org/2000/svg','g');
                    group.classList.add('point-group');
                    group.onclick=(e)=>{e.stopPropagation();this.togglePoint(p.id);}

                    const hit = document.createElementNS('http://www.w3.org/2000/svg','circle');
                    hit.setAttribute('cx',n.x); hit.setAttribute('cy',n.y); hit.setAttribute('r',45); hit.classList.add('hit-area'); // Massive hit area

                    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
                    c.setAttribute('cx',n.x); c.setAttribute('cy',n.y); c.setAttribute('r',6); c.classList.add('point-circle');
                    
                    const i = document.createElementNS('http://www.w3.org/2000/svg','circle');
                    i.setAttribute('cx',n.x); i.setAttribute('cy',n.y); i.setAttribute('r',3); i.classList.add('point-indicator'); i.id=`visual_point_ind_${p.id}`;
                    
                    const arrow = document.createElementNS('http://www.w3.org/2000/svg','path');
                    arrow.id = `arrow_${p.id}`; arrow.classList.add('point-arrow');
                    this.updatePointArrow(p, arrow);
                    
                    group.appendChild(hit); group.appendChild(c); group.appendChild(i); group.appendChild(arrow);
                    this.svg.appendChild(group);
                });

                SIGNALS.forEach(s => {
                    const n = NODES[s.node];
                    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
                    g.setAttribute('transform',`translate(${n.x},${n.y})`);
                    const l = document.createElementNS('http://www.w3.org/2000/svg','line');
                    l.setAttribute('x1',0); l.setAttribute('y1',0); l.setAttribute('x2',0); l.setAttribute('y2',s.direction==='up'?-15:15);
                    l.setAttribute('stroke','#444'); l.setAttribute('stroke-width',2);
                    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
                    c.setAttribute('cx',0); c.setAttribute('cy',s.direction==='up'?-15:15); c.setAttribute('r',5); c.classList.add('signal-light','signal-active-red'); c.id=`visual_sig_${s.id}`;
                    const hit = document.createElementNS('http://www.w3.org/2000/svg','circle');
                    hit.setAttribute('cx',0); hit.setAttribute('cy',s.direction==='up'?-15:15); hit.setAttribute('r',30); hit.classList.add('hit-area');
                    hit.onclick=(e)=>{e.stopPropagation();this.toggleSignal(s.id);}
                    g.appendChild(l); g.appendChild(hit); g.appendChild(c);
                    this.svg.appendChild(g);
                });
            }

            updatePointArrow(point, el) {
                const trkId = point.state === 'normal' ? point.normal : point.reverse;
                const trk = TRACKS.find(t => t.id === trkId);
                const n = NODES[point.node];
                const otherNode = (trk.u === point.node) ? NODES[trk.v] : NODES[trk.u];
                const dx = otherNode.x - n.x; const dy = otherNode.y - n.y;
                const len = Math.sqrt(dx*dx + dy*dy);
                const x = (dx/len) * 20; const y = (dy/len) * 20;
                el.setAttribute('d', `M${n.x},${n.y} L${n.x+x},${n.y+y}`);
            }

            handleTrackClick(trackId) {
                if (this.maintenanceMode) {
                    const el = document.getElementById(`visual_${trackId}`);
                    if(this.maintenanceTracks.has(trackId)){this.maintenanceTracks.delete(trackId);el.classList.remove('maintenance');}
                    else{this.maintenanceTracks.add(trackId);el.classList.add('maintenance');}
                    return;
                }
                const point = POINTS.find(p => p.normal === trackId || p.reverse === trackId);
                if (point) {
                    const desiredState = (point.normal === trackId) ? 'normal' : 'reverse';
                    if (point.state !== desiredState) this.togglePoint(point.id, desiredState);
                }
            }

            togglePoint(pid, specificState = null) {
                if(!this.isRunning) return;
                const pt = POINTS.find(p=>p.id===pid);
                const nextState = specificState || (pt.state==='normal'?'reverse':'normal');
                if (pt.state === nextState) return;
                
                const isOccupied = this.trains.some(t => {
                    const track = TRACKS.find(tr => tr.id === t.currentTrackId);
                    return (track.u === pt.node || track.v === pt.node) && t.progress > 0.5; 
                });
                if(isOccupied) { this.log("Point Locked by Train", "error"); playSound('error'); return; }
                
                pt.state = nextState;
                document.getElementById(`visual_point_ind_${pid}`).style.opacity = pt.state==='reverse'?'1':'0';
                this.updatePointArrow(pt, document.getElementById(`arrow_${pid}`));
                this.resetSignals(); playSound('click'); this.updateRoutes();
            }

            toggleSignal(sid) {
                if(!this.isRunning) return;
                const sig = SIGNALS.find(s=>s.id===sid);
                if(sig.state!=='red') { sig.state='red'; this.updateSignalVisual(sig); return; }
                
                if(this.checkPathClear(sig)) {
                    // 4-Aspect Logic
                    const nextTrack = this.getNextTrack(sig.node, sig.direction==='up'?1:-1);
                    if(sid.startsWith('s_st') || sid === 's_adv_down') sig.state = 'green';
                    else {
                        if (nextTrack && nextTrack.isPlatform) sig.state = 'yellow';
                        else {
                            // Check signal after next
                            const nextSig = this.getNextSignal(nextTrack, sig.direction);
                            if (!nextSig || nextSig.state === 'red') sig.state = 'yellow';
                            else if (nextSig.state === 'yellow') sig.state = 'double-yellow';
                            else sig.state = 'green';
                        }
                    }
                    playSound('success');
                } else {
                    this.log("Route Blocked", "error"); playSound('error');
                }
                this.updateSignalVisual(sig); this.updateRoutes();
            }

            checkPathClear(sig) {
                const nextTrack = this.getNextTrack(sig.node, sig.direction==='up'?1:-1);
                if(!nextTrack) return false;
                if(this.maintenanceTracks.has(nextTrack.id)) return false;
                return !this.trains.some(t=>t.currentTrackId===nextTrack.id);
            }

            getNextTrack(nodeId, dir) {
                const pt = POINTS.find(p=>p.node===nodeId);
                if(dir===1) { // Moving Right (Up)
                    if(pt) return TRACKS.find(t=>t.id === (pt.state==='normal'?pt.normal:pt.reverse));
                    return TRACKS.find(t=>t.u===nodeId);
                } else { // Moving Left (Down)
                    return TRACKS.find(t=>t.v===nodeId);
                }
            }

            getNextSignal(track, dir) {
                // Simplified lookahead
                const nextNode = dir==='up' ? track.v : track.u;
                return SIGNALS.find(s => s.node === nextNode && s.direction === dir);
            }

            resetSignals() { SIGNALS.forEach(s=>{if(s.state!=='red'){s.state='red';this.updateSignalVisual(s);}}); }
            updateSignalVisual(s) {
                const el = document.getElementById(`visual_sig_${s.id}`);
                el.className.baseVal = `signal-light signal-active-${s.state}`;
            }
            updateRoutes() {
                document.querySelectorAll('.track-line').forEach(e=>e.classList.remove('route-locked'));
                SIGNALS.forEach(s=>{
                    if(s.state!=='red') {
                        let next = this.getNextTrack(s.node, s.direction==='up'?1:-1);
                        if(next) document.getElementById(`visual_${next.id}`).classList.add('route-locked');
                    }
                });
            }

            spawnTrain(type) {
                if(!this.isRunning) return;
                if(this.trains.some(t=>t.currentTrackId==='t_up_1')) { this.log("UP Main Occupied","error"); return; }
                const pool = type==='local'?LOCAL_NAMES:EXPRESS_NAMES;
                const name = pool[Math.floor(Math.random()*pool.length)] + (type==='local'?' EMU':' Exp');
                const t = new Train(this.trainIdCounter++, type, name);
                this.trains.push(t);
                
                const g = document.createElementNS('http://www.w3.org/2000/svg','g');
                g.setAttribute('class','train-group'); g.id=`train_${t.id}`;
                // Click listener for ACP reset
                g.onclick = (e) => { e.stopPropagation(); this.resetACP(t); };
                
                const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
                r.setAttribute('width',30); r.setAttribute('height',10); r.setAttribute('rx',3); r.classList.add(`train-${type}`);
                const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
                txt.setAttribute('x',15); txt.setAttribute('y',-5); txt.classList.add('train-label'); txt.textContent=t.name;
                g.appendChild(r); g.appendChild(txt); this.svg.appendChild(g);
                this.log(`${t.name} arriving.`); this.updateCounts();
            }

            resetACP(train) {
                if (train.acpActive) {
                    train.acpActive = false;
                    document.getElementById(`train_${train.id}`).classList.remove('train-acp');
                    this.log(`${train.name}: Alarm Reset. Resuming.`, "success");
                    playSound('success');
                }
            }

            loop(ts) {
                if(!this.isRunning) return;
                const dt = (ts-this.lastFrame)/1000; this.lastFrame=ts;
                
                // Time & Day/Night
                this.gameTime += dt * (this.timeRate/60); // min per sec
                if(this.gameTime >= 24*60) this.gameTime = 0;
                const hrs = Math.floor(this.gameTime/60);
                const mins = Math.floor(this.gameTime%60);
                document.getElementById('game-time').innerText = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}`;
                
                if (hrs >= 18 || hrs < 6) document.body.classList.add('night-mode');
                else document.body.classList.remove('night-mode');

                this.updateTrains(dt); requestAnimationFrame(t=>this.loop(t));
            }

            updateTrains(dt) {
                const occ = new Set();
                this.trains.forEach((t,i) => {
                    const vis = document.getElementById(`train_${t.id}`);
                    
                    // ACP Logic (Random)
                    if (t.state === 'running' && t.speed > 0.3 && !t.acpActive && Math.random() < 0.0002) {
                        t.acpActive = true;
                        vis.classList.add('train-acp');
                        this.log(`üö® ${t.name}: PASSENGER ALARM! Click train to reset!`, "error");
                        playSound('acp');
                    }

                    if (t.acpActive) {
                        t.speed = Math.max(0, t.speed - 3.0 * dt); // Emergency brake
                    } else if(t.state==='waiting') {
                        t.waitTime-=dt;
                        if(t.waitTime<=0) { t.state='departing'; t.direction=-1; this.log(`${t.name} ready for departure.`); }
                    } else if(t.state!=='waiting') {
                        const trk = TRACKS.find(tr=>tr.id===t.currentTrackId);
                        let sig = null; let dist = 0;
                        if(t.direction===1) { // UP
                            dist = 1.0 - t.progress;
                            sig = SIGNALS.find(s=>s.node===trk.v && s.direction==='up');
                        } else { // DOWN
                            dist = t.progress;
                            sig = SIGNALS.find(s=>s.node===trk.u && s.direction==='down');
                        }

                        let target = t.maxSpeed * (trk.limit||1.0);
                        if(sig && sig.state==='red' && dist < 0.6) target = 0;
                        else if(sig && sig.state==='yellow') target *= 0.25;
                        else if(sig && sig.state==='double-yellow') target *= 0.5;

                        if(t.speed < target) t.speed += dt*0.5; else t.speed -= dt * 1.2;
                        t.speed = Math.max(0, t.speed);

                        if (sig && sig.state === 'red' && dist < 0.3 && t.speed > 0.1) t.speed = Math.max(0, t.speed - 4.0 * dt);

                        t.progress += (t.speed*dt*0.4) * t.direction;

                        if(t.progress >= 1) { 
                            if(trk.isPlatform) {
                                // Platform Length Check
                                if (trk.short && t.type === 'express') {
                                    this.gameOver("Platform Overshoot: Long train on Short Platform"); return;
                                }
                                t.progress=1; t.speed=0; t.state='waiting'; t.waitTime=5;
                                this.log(`${t.name} Arrived.`); this.score+=10; this.updateScore();
                                const prevSig = SIGNALS.find(s=>s.node===trk.u && s.direction==='up');
                                if(prevSig) { prevSig.state='red'; this.updateSignalVisual(prevSig); }
                            } else {
                                const next = this.getNextTrack(trk.v, 1);
                                if(next) {
                                    const sigCheck = SIGNALS.find(s=>s.node===trk.v && s.direction==='up');
                                    if(sigCheck && sigCheck.state==='red' && t.speed > 0.1) { this.gameOver("SPAD Violation"); return; }
                                    if(sig) { sig.state='red'; this.updateSignalVisual(sig); }
                                    t.currentTrackId=next.id; t.progress=0;
                                } else t.progress=1;
                            }
                        } else if(t.progress <= 0) { 
                            if(t.currentTrackId==='t_down_1') {
                                this.log(`${t.name} Departed.`); this.score+=20; this.updateScore();
                                vis.remove(); this.trains.splice(i,1); this.updateCounts(); return;
                            }
                            const candidates = TRACKS.filter(x=>x.v===trk.u);
                            const next = candidates.length > 0 ? candidates[0] : null; 
                            if(next) {
                                if(sig) { sig.state='red'; this.updateSignalVisual(sig); }
                                t.currentTrackId = next.id; t.progress=1;
                            }
                        }
                    }
                    
                    occ.add(t.currentTrackId);
                    const trk = TRACKS.find(tr=>tr.id===t.currentTrackId);
                    const u = NODES[trk.u], v = NODES[trk.v];
                    const x = u.x + (v.x-u.x)*t.progress; const y = u.y + (v.y-u.y)*t.progress;
                    const angle = Math.atan2(v.y-u.y, v.x-u.x)*180/Math.PI;
                    vis.setAttribute('transform', `translate(${x},${y}) rotate(${angle})`);
                });

                TRACKS.forEach(tr => {
                    const el = document.getElementById(`visual_${tr.id}`);
                    if(occ.has(tr.id)) el.classList.add('occupied'); else el.classList.remove('occupied');
                });
            }

            updateCounts() { document.getElementById('train-count').innerText=this.trains.length; }
            updateScore() { document.getElementById('score').innerText=this.score; }
            log(msg, type='normal') {
                const d = document.createElement('div'); d.className=`log-entry ${type==='error'?'log-err':type==='success'?'log-success':''}`; 
                d.textContent=`[${document.getElementById('game-time').innerText}] ${msg}`;
                const p=document.getElementById('log'); p.insertBefore(d,p.firstChild);
            }
            toggleMaintenanceMode() { this.maintenanceMode=!this.maintenanceMode; document.getElementById('btn-maint').classList.toggle('active'); }
            triggerAnnouncement(){} consultControl(){} generateAccidentReport(){} emergencyStop(){} resetBoard(){location.reload();}
            gameOver(reason) {
                this.isRunning = false; playSound('error');
                document.getElementById('fail-reason').innerText = reason; document.getElementById('final-score').innerText = "Score: " + this.score;
                document.getElementById('game-over-overlay').classList.add('active');
            }
        }
        const game = new Game(); game.init();
    </script>
</body>
</html>